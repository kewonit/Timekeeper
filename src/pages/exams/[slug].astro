---
import Layout from '../../layouts/Layout.astro';
import { getExamData, type ExamData } from '../../data/exam-data';
import StudyTimerMap from '../../components/StudyTimerMap.astro';

export async function getStaticPaths() {
  const exams = getExamData();
  
  return exams.map((exam) => ({
    params: { slug: exam.slug },
    props: { exam },
  }));
}

const { exam } = Astro.props as { exam: ExamData };
const allExams = getExamData();

// Get related exams data
const relatedExamsData = exam.relatedExams
  .map(slug => allExams.find(e => e.slug === slug))
  .filter((exam): exam is ExamData => !!exam)
  .slice(0, 4);
---

<Layout exam={exam}>
  <style>
    .countdown-number {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
      color: var(--text-primary) !important;
    }
    
    .countdown-label {
      color: var(--text-secondary) !important;
    }
    
    .countdown-display {
      background-color: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
    }
    
    .countdown-number.flip {
      animation: flipAnimation 0.3s ease-in-out;
    }
    
    @keyframes flipAnimation {
      0% { transform: rotateX(0deg); }
      50% { transform: rotateX(-90deg); }
      100% { transform: rotateX(0deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    /* Responsive improvements */
    @media (max-width: 640px) {
      .countdown-display .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      .countdown-number {
        font-size: 2rem !important;
        line-height: 1.1;
      }
      
      .countdown-label {
        font-size: 0.75rem !important;
      }
    }
    
    @media (max-width: 480px) {
      .countdown-display {
        padding: 1rem !important;
      }
      
      .countdown-display .grid {
        gap: 0.5rem;
      }
      
      .countdown-number {
        font-size: 1.75rem !important;
      }
      
      .countdown-label {
        font-size: 0.7rem !important;
      }
    }
    
    @media (max-width: 360px) {
      .countdown-number {
        font-size: 1.5rem !important;
      }
      
      .countdown-label {
        font-size: 0.65rem !important;
      }
    }
    
    /* Fullscreen responsive */
    @media (max-width: 768px) {
      #fullscreen-countdown .grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 1.5rem !important;
      }
      
      #fullscreen-countdown .countdown-number {
        font-size: 3rem !important;
      }
      
      #fullscreen-countdown .countdown-label {
        font-size: 0.875rem !important;
      }
    }
    
    @media (max-width: 480px) {
      #fullscreen-countdown .countdown-number {
        font-size: 2.5rem !important;
      }
      
      #fullscreen-countdown .countdown-label {
        font-size: 0.75rem !important;
      }
      
      #fullscreen-countdown .grid {
        gap: 1rem !important;
      }
    }
    
    @media (max-width: 360px) {
      #fullscreen-countdown .countdown-number {
        font-size: 2rem !important;
      }
      
      #fullscreen-countdown .countdown-label {
        font-size: 0.7rem !important;
      }
    }

    /* Fullscreen Modal transitions */
    #fullscreen-modal {
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #fullscreen-modal.hidden {
      opacity: 0;
      visibility: hidden;
    }
    #fullscreen-modal:not(.hidden) {
      opacity: 1;
      visibility: visible;
    }
  </style>
  <!-- Fullscreen Countdown Modal -->
  <div id="fullscreen-modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300 opacity-0">
    <div class="h-full flex flex-col items-center justify-center p-8">
      <div class="text-center mb-8">
        <h1 class="font-serif italic text-4xl lg:text-6xl mb-4">{exam.name}</h1>
        <p class="text-xl lg:text-2xl" id="fullscreen-session-info"></p>
      </div>
      
      <div id="fullscreen-countdown" class="mb-8">
        <!-- Countdown will be populated by JavaScript -->
      </div>
      
      <button 
        onclick="closeFullscreen()"
        class="fixed top-4 right-4 px-3 py-2 text-sm rounded-lg transition-all opacity-75 hover:opacity-100 flex items-center gap-2"
        title="Exit Fullscreen (ESC)"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        ESC
      </button>
    </div>
  </div>

  <div class="min-h-screen themed-bg">
    <!-- Header Navigation -->
    <nav class="border-b border-dashed themed-border themed-bg sticky top-0 z-20">
      <div class="max-w-7xl mx-auto px-4 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <a href="/" class="flex items-center gap-2 themed-text hover:text-blue-600 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              <span class="text-sm">All Exams</span>
            </a>
          </div>
          <div class="flex items-center gap-4">
            <span class="font-serif italic text-lg themed-text-secondary">TimeKeeper</span>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-5xl mx-auto px-4 lg:px-8 py-8 pb-8">
      <!-- Exam Header -->
      <div class="text-center mb-8">
        <h1 class="font-serif italic text-3xl sm:text-4xl lg:text-6xl themed-text mb-4">{exam.name}</h1>
        <p class="text-lg sm:text-xl lg:text-2xl themed-text-secondary mb-6">{exam.fullName}</p>
        
        <div class="flex items-center justify-center gap-2 sm:gap-3 flex-wrap mb-6">
          <span class={`inline-block px-3 sm:px-4 py-2 text-xs sm:text-sm border rounded-full ${
            exam.category === 'Engineering' ? 'bg-blue-50 text-blue-700 border-blue-200' :
            exam.category === 'Medical' ? 'bg-green-50 text-green-700 border-green-200' :
            exam.category === 'Management' ? 'bg-purple-50 text-purple-700 border-purple-200' :
            exam.category === 'Civil Services' ? 'bg-orange-50 text-orange-700 border-orange-200' :
            exam.category === 'Banking' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' :
            exam.category === 'Defence' ? 'bg-red-50 text-red-700 border-red-200' :
            exam.category === 'Government Jobs' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' :
            exam.category === 'Law' ? 'bg-gray-50 text-gray-700 border-gray-200' :
            exam.category === 'Teaching' ? 'bg-pink-50 text-pink-700 border-pink-200' :
            exam.category === 'Railway' ? 'bg-teal-50 text-teal-700 border-teal-200' :
            'bg-gray-50 text-gray-700 border-gray-200'
          }`}>
            {exam.category}
          </span>

          <span class="inline-block px-3 sm:px-4 py-2 text-xs sm:text-sm themed-bg-tertiary themed-text-secondary rounded-full">
            {exam.conductingBody}
          </span>
        </div>

        <p class="text-base sm:text-lg themed-text-secondary leading-relaxed max-w-3xl mx-auto px-4">{exam.description}</p>
      </div>

      <!-- Large Countdown Display -->
      <div class="border border-dashed themed-border rounded-lg p-2 sm:p-4 lg:p-6 xl:p-8 mb-6 sm:mb-8 relative">
          <div class="text-center">
          <div class="flex flex-col gap-2 sm:gap-3 mb-3 sm:mb-4 lg:mb-6">
            <!-- Session info and controls on mobile, side by side on larger screens -->
            <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-2 sm:gap-3">
              <div class="flex-1 text-left">
                <h2 id="current-session-name" class="text-base sm:text-lg lg:text-xl xl:text-2xl font-medium themed-text mb-0.5 sm:mb-1 lg:mb-2">
                  {exam.sessions[0].session}
                </h2>
                <p id="current-session-date" class="text-xs sm:text-sm lg:text-base xl:text-lg themed-text-secondary">
                  {new Date(exam.sessions[0].date).toLocaleDateString('en-IN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                  })}
                </p>
              </div>
              <div class="flex flex-col gap-1.5 sm:gap-2 lg:gap-3 sm:self-start">
                <!-- Session Toggle (if multiple sessions) -->
                {exam.sessions.length > 1 && (
                  <div class="flex justify-center sm:justify-end">
                    <div class="themed-bg-tertiary p-0.5 rounded-lg inline-flex flex-wrap gap-0.5">
                      {exam.sessions.map((session, index) => (
                        <button 
                          onclick={`switchSession(${index})`}
                          class={`session-toggle px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 ${
                            index === 0 ? 'active' : ''
                          }`}
                          data-session={index}
                        >
                          {session.session}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                <div class="flex gap-1.5 sm:gap-2 justify-center sm:justify-end">
                  <button 
                    onclick="enterFullscreen()"
                    class="action-button-mobile px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 text-xs sm:text-sm themed-text-secondary hover:themed-text border border-dashed themed-border hover:themed-border-secondary rounded-md transition-all duration-200 flex items-center gap-1 sm:gap-2"
                    title="Fullscreen Countdown"
                  >
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                    <span class="button-text hidden sm:inline">Fullscreen</span>
                    <span class="button-text-mobile sm:hidden">Full</span>
                  </button>
                  <button 
                    onclick="togglePiPWidget()"
                    class="action-button-mobile px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 text-xs sm:text-sm themed-text-secondary hover:themed-text border border-dashed themed-border hover:themed-border-secondary rounded-md transition-all duration-200 flex items-center gap-1 sm:gap-2"
                    title="Pop-Out Countdown"
                  >
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <rect x="2" y="3" width="20" height="14" rx="2" ry="2" stroke-width="2"/>
                      <rect x="8" y="8" width="8" height="6" rx="1" ry="1" stroke-width="2"/>
                    </svg>
                    <span class="button-text hidden sm:inline">Pop-Out</span>
                    <span class="button-text-mobile sm:hidden">Pop</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div id="main-countdown" class="countdown-display themed-bg-secondary p-3 sm:p-6 lg:p-8 xl:p-12 rounded-lg">
            <!-- Countdown will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Exam Details Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8">
        <!-- Basic Info -->
        <div class="border border-dashed themed-border p-4 sm:p-6 rounded-lg">
          <h3 class="font-serif italic text-lg sm:text-xl mb-4 themed-text">Basic Information</h3>
          <div class="space-y-4 text-sm">
            <!-- Duration -->
            <div class="flex flex-col sm:flex-row sm:justify-between">
              <span class="themed-text-tertiary">Duration:</span>
              <span class="themed-text font-medium sm:text-right">{exam.duration}</span>
            </div>
            <!-- Eligibility -->
            <div class="flex flex-col sm:flex-row sm:justify-between">
              <span class="themed-text-tertiary flex-shrink-0 mr-4">Eligibility:</span>
              <span class="themed-text font-medium sm:text-right break-words">{exam.eligibility}</span>
            </div>
            <!-- Total Seats -->
            {exam.seats && exam.seats !== 'N/A' && (
              <div class="flex flex-col sm:flex-row sm:justify-between">
                <span class="themed-text-tertiary">Total Seats:</span>
                <span class="themed-text font-medium sm:text-right">{exam.seats}</span>
              </div>
            )}
            <!-- Sessions -->
            <div class="flex flex-col sm:flex-row sm:justify-between">
              <span class="themed-text-tertiary">Sessions:</span>
              <span class="themed-text font-medium sm:text-right">{exam.sessions.length}</span>
            </div>
          </div>
        </div>

        <!-- Subjects -->
        <div class="border border-dashed themed-border p-4 sm:p-6 rounded-lg">
          <h3 class="font-serif italic text-lg sm:text-xl mb-4 themed-text">Subjects</h3>
          <div class="flex flex-wrap gap-2">
            {exam.subjects.map((subject) => (
              <span class="inline-block px-2 sm:px-3 py-1 text-xs sm:text-sm themed-bg-tertiary themed-text-secondary rounded-full">
                {subject}
              </span>
            ))}
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="border border-dashed themed-border p-4 sm:p-6 rounded-lg md:col-span-2 lg:col-span-1">
          <h3 class="font-serif italic text-lg sm:text-xl mb-4 themed-text">Quick Links</h3>
          <div class="space-y-3">
            {exam.officialWebsite && (
              <a 
                href={exam.officialWebsite} 
                target="_blank" 
                rel="noopener noreferrer"
                class="block w-full px-4 py-2 text-sm text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-md transition-colors text-center"
              >
                Official Website ↗
              </a>
            )}
            <button 
              onclick="shareExam()"
              class="block w-full px-4 py-2 text-sm themed-text-secondary themed-bg-secondary hover:themed-bg-tertiary border themed-border rounded-md transition-colors"
            >
              Share This Exam
            </button>
          </div>
        </div>
      </div>

      <!-- Live Study Map -->
      <div class="mb-8">
        <StudyTimerMap exam={exam} height="400px" showTimer={false} />
      </div>

      <!-- Related Exams -->
      {relatedExamsData.length > 0 && (
        <div class="border border-dashed themed-border p-4 sm:p-6 rounded-lg mb-8">
          <h3 class="font-serif italic text-xl sm:text-2xl mb-6 themed-text">Related Exams</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {relatedExamsData.map((relatedExam) => (
              <a 
                href={`/exams/${relatedExam.slug}`}
                class="block p-4 border border-dashed themed-border rounded-lg hover:themed-border-secondary transition-colors group"
              >
                <h4 class="font-medium text-sm sm:text-base themed-text group-hover:text-blue-600 mb-2">{relatedExam.name}</h4>
                <p class="text-xs themed-text-tertiary mb-2">{relatedExam.category}</p>
                <div class="text-xs text-blue-600 group-hover:text-blue-800">View Details →</div>
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Important Notice -->
      <div class="border border-dashed themed-disclaimer p-3 sm:p-4 rounded-lg">
        <div class="flex items-start gap-2">
          <svg class="w-4 h-4 themed-disclaimer-accent mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.072-.833-2.842 0L4.982 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          <div class="flex-1">
            <h3 class="text-sm font-medium themed-disclaimer-accent mb-1">Disclaimer</h3>
            <p class="text-xs themed-disclaimer leading-relaxed">
              Please verify exam dates from {exam.conductingBody}'s official website. 
              This countdown is for reference only.
            </p>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ exam }}>
    let currentSessionIndex = 0;
    let countdownInterval;

    function formatTimeRemaining(targetDate) {
      const now = new Date().getTime();
      const target = new Date(targetDate).getTime();
      const distance = target - now;
      
      if (distance < 0) {
        return { expired: true, text: "Exam has passed" };
      }
      
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      
      return { expired: false, days, hours, minutes, seconds };
    }

    function setupCountdown(containerId, isFullscreen = false) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const sizeClasses = isFullscreen 
        ? "text-6xl sm:text-8xl lg:text-9xl" 
        : "text-3xl sm:text-5xl lg:text-7xl";
      const labelSizeClasses = isFullscreen
        ? "text-xl sm:text-2xl"
        : "text-sm sm:text-lg";
      const gridGap = isFullscreen ? "gap-6 sm:gap-12" : "gap-3 sm:gap-6";

      container.innerHTML = `
        <div class="grid grid-cols-2 lg:grid-cols-4 ${gridGap}">
          ${['Days', 'Hours', 'Minutes', 'Seconds'].map(label => `
            <div class="text-center">
              <div class="countdown-number ${sizeClasses} font-bold themed-text mb-2" data-unit="${label.toLowerCase()}">0</div>
              <div class="countdown-label ${labelSizeClasses} themed-text-secondary">${label}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function updateCountdown(containerId, timeRemaining) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (timeRemaining.expired) {
        container.innerHTML = `<p class="text-xl sm:text-2xl font-medium text-red-600 fade-in">${timeRemaining.text}</p>`;
        return;
      }

      const units = ['days', 'hours', 'minutes', 'seconds'];
      units.forEach(unit => {
        const element = container.querySelector(`[data-unit="${unit}"]`);
        if (element && element.textContent !== String(timeRemaining[unit])) {
          element.textContent = timeRemaining[unit];
        }
      });
    }

    function startTicking() {
      const currentSession = exam.sessions[currentSessionIndex];
      const timeRemaining = formatTimeRemaining(currentSession.date);
      
      updateCountdown('main-countdown', timeRemaining);
      updateCountdown('fullscreen-countdown', timeRemaining);

      countdownInterval = setInterval(() => {
        const session = exam.sessions[currentSessionIndex];
        const remaining = formatTimeRemaining(session.date);
        updateCountdown('main-countdown', remaining);
        if (!document.getElementById('fullscreen-modal').classList.contains('hidden')) {
          updateCountdown('fullscreen-countdown', remaining);
        }
        if (remaining.expired) {
          clearInterval(countdownInterval);
        }
      }, 1000);
    }

    function switchSession(index) {
      currentSessionIndex = index;
      const currentSession = exam.sessions[index];
      
      document.getElementById('current-session-name').textContent = currentSession.session;
      document.getElementById('current-session-date').textContent = new Date(currentSession.date).toLocaleDateString('en-IN', { 
        year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
      });
      
      document.querySelectorAll('.session-toggle').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
      });
      
      if (countdownInterval) clearInterval(countdownInterval);
      startTicking();
      
      if (document.pictureInPictureElement) {
        startPiPCountdown(exam, currentSession);
      }
    }

    function enterFullscreen() {
      const modal = document.getElementById('fullscreen-modal');
      const currentSession = exam.sessions[currentSessionIndex];
      
      document.getElementById('fullscreen-session-info').textContent = 
        `${currentSession.session} - ${new Date(currentSession.date).toLocaleDateString('en-IN', { 
          year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
        })}`;
      
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      updateCountdown('fullscreen-countdown', formatTimeRemaining(currentSession.date));
    }

    function closeFullscreen() {
      const modal = document.getElementById('fullscreen-modal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function shareExam() {
      if (navigator.share) {
        navigator.share({
          title: `${exam.name} 2026 Countdown`,
          text: `Track the countdown to ${exam.fullName} exam`,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('Link copied to clipboard!');
        });
      }
    }

    function togglePiPWidget() {
      const currentSession = exam.sessions[currentSessionIndex];
      startPiPCountdown(exam, currentSession);
    }

    // Make functions global
    window.switchSession = switchSession;
    window.enterFullscreen = enterFullscreen;
    window.closeFullscreen = closeFullscreen;
    window.shareExam = shareExam;
    window.togglePiPWidget = togglePiPWidget;

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !document.getElementById('fullscreen-modal').classList.contains('hidden')) {
        closeFullscreen();
      } else if (e.key === 'f' || e.key === 'F') {
        const modal = document.getElementById('fullscreen-modal');
        modal.classList.contains('hidden') ? enterFullscreen() : closeFullscreen();
      }
    });

    // Initialize countdowns
    document.addEventListener('DOMContentLoaded', () => {
      setupCountdown('main-countdown', false);
      setupCountdown('fullscreen-countdown', true);
      startTicking();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (countdownInterval) clearInterval(countdownInterval);
    });
  </script>
</Layout>


