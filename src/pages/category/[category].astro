---
import Layout from '../../layouts/Layout.astro';
import { getExamData, type ExamData } from '../../data/exam-data';

export async function getStaticPaths() {
  const exams = getExamData();
  const categories = [...new Set(exams.map(exam => exam.category))];
  
  return categories.map((category) => ({
    params: { category: category.toLowerCase().replace(/\s+/g, '-') },
    props: { category, categorySlug: category.toLowerCase().replace(/\s+/g, '-') },
  }));
}

const { category, categorySlug } = Astro.props;
const allExams = getExamData();
const exams = allExams.filter(exam => 
  exam.category.toLowerCase() === category.toLowerCase()
);

const title = `${category} Exams Countdown Timer 2026 | TimeKeeper`;
const description = `Track countdown timers for all ${category.toLowerCase()} competitive exams 2026. Real-time countdown for ${exams.map(e => e.name).join(', ')} and more. Never miss an exam date.`;
const keywords = [
  `${category.toLowerCase()} exams 2026`,
  `${category.toLowerCase()} countdown timer`,
  `${category.toLowerCase()} entrance exams`,
  `${category.toLowerCase()} exam dates`,
  ...exams.flatMap(exam => exam.keywords)
];
---

<Layout>
  <div class="min-h-screen themed-bg">
    <!-- Header -->
    <header class="themed-bg sticky top-0 z-30 border-b border-dashed themed-border">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <a href="/" class="flex items-center gap-3">
            <span class="font-serif italic text-2xl themed-text">TimeKeeper</span>
          </a>
          <a href="/" class="text-sm themed-text-secondary hover:themed-text transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            All Categories
          </a>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Category Header -->
      <div class="text-center mb-16">
        <h1 class="text-4xl md:text-6xl font-serif themed-text mb-4">{category} Exams</h1>
        <p class="text-lg md:text-xl themed-text-secondary max-w-3xl mx-auto">
          Live countdown timers for all major {category.toLowerCase()} competitive exams in India.
        </p>
      </div>

      <!-- Exams Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {exams.map(exam => (
          <a href={`/exams/${exam.slug}`} class="group block">
            <div class="themed-bg-secondary border themed-border rounded-xl p-6 h-full transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold themed-text">{exam.name}</h3>
                <span class="text-xs themed-bg-tertiary themed-text-secondary px-2 py-1 rounded-full">{exam.conductingBody}</span>
              </div>
              
              <p class="text-sm themed-text-secondary mb-6 min-h-[40px]">{exam.fullName}</p>

              <div class="countdown-display mb-6" data-target={exam.sessions?.[0]?.date}>
                {/* Countdown will be populated by script */}
              </div>

              <div class="flex justify-between items-center text-sm themed-text-secondary">
                <span>Next Session:</span>
                <span class="font-medium themed-text">
                  {new Date(exam.sessions?.[0]?.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </main>
  </div>

  <script>
    function createCountdownHTML() {
      return `
        <div class="grid grid-cols-4 gap-2 text-center">
          ${['Days', 'Hours', 'Min', 'Sec'].map(label => `
            <div>
              <div class="countdown-number text-3xl font-bold themed-text">00</div>
              <div class="countdown-label text-xs themed-text-secondary">${label}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function formatTimeRemaining(targetDate: string | null) {
      if (!targetDate) return { expired: true };
      const now = new Date().getTime();
      const target = new Date(targetDate).getTime();
      const distance = target - now;
      
      if (distance < 0) return { expired: true };
      
      return {
        expired: false,
        days: Math.floor(distance / (1000 * 60 * 60 * 24)),
        hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
        minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)),
        seconds: Math.floor((distance % (1000 * 60)) / 1000)
      };
    }

    function updateAllCountdowns() {
      const countdownElements = document.querySelectorAll('.countdown-display');
      
      countdownElements.forEach(element => {
        if (!element.innerHTML) {
          element.innerHTML = createCountdownHTML();
        }

        const targetDate = element.getAttribute('data-target');
        const time = formatTimeRemaining(targetDate);
        const numbers = element.querySelectorAll('.countdown-number');

        if (time.expired) {
          numbers.forEach(num => num.textContent = '00');
          element.closest('a')?.classList.add('opacity-60', 'pointer-events-none');
        } else {
          numbers[0].textContent = String(time.days).padStart(2, '0');
          numbers[1].textContent = String(time.hours).padStart(2, '0');
          numbers[2].textContent = String(time.minutes).padStart(2, '0');
          numbers[3].textContent = String(time.seconds).padStart(2, '0');
        }
      });
    }

    const interval = setInterval(updateAllCountdowns, 1000);
    document.addEventListener('DOMContentLoaded', updateAllCountdowns);
    window.addEventListener('beforeunload', () => clearInterval(interval));
  </script>
</Layout>
