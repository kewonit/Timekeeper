---
/**
 * StudySessionWidget Component
 * 
 * A compact widget that shows studying status and allows joining the live study map.
 * Designed to be embedded in exam pages alongside the countdown timer.
 */

export interface Props {
  examSlug?: string;
  examName?: string;
}

const { examSlug, examName } = Astro.props;
---

<div 
  class="study-session-widget border border-dashed themed-border rounded-lg overflow-hidden"
  data-exam-slug={examSlug || ''}
  data-exam-name={examName || ''}
>
  <!-- Widget Header -->
  <div class="flex items-center justify-between p-3 sm:p-4 themed-bg-secondary">
    <div class="flex items-center gap-2">
      <div class="relative">
        <div class="w-2.5 h-2.5 bg-green-500 rounded-full"></div>
        <div class="absolute inset-0 w-2.5 h-2.5 bg-green-500 rounded-full animate-ping opacity-75"></div>
      </div>
      <span class="text-sm font-medium themed-text">Study Together</span>
    </div>
    <a 
      href="/study-map"
      class="text-xs themed-text-secondary hover:themed-text transition-colors flex items-center gap-1"
    >
      View Map
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
    </a>
  </div>
  
  <!-- Widget Content -->
  <div class="p-3 sm:p-4 themed-bg">
    <!-- Not Studying State -->
    <div id="widget-not-studying" class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div class="flex-1">
        <p class="text-sm themed-text-secondary">
          <span id="widget-active-count" class="font-medium themed-text">0</span> students preparing{examName ? ` for ${examName}` : ''} right now
        </p>
      </div>
      <button
        id="widget-join-btn"
        class="px-3 py-1.5 text-xs sm:text-sm themed-accent-button font-medium rounded-md transition-all duration-200 whitespace-nowrap flex items-center gap-1.5"
      >
        <span>ðŸš€</span>
        <span>Join Session</span>
      </button>
    </div>
    
    <!-- Studying State -->
    <div id="widget-studying" class="hidden">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <span id="widget-avatar" class="text-xl">ðŸ“š</span>
          <div>
            <p class="text-sm themed-text font-medium">You're studying!</p>
            <p class="text-xs themed-text-secondary">
              <span id="widget-location">India</span> â€¢ <span id="widget-duration">just now</span>
            </p>
          </div>
        </div>
        <button
          id="widget-stop-btn"
          class="px-2 py-1 text-xs themed-text-tertiary hover:themed-text-secondary border border-dashed themed-border rounded transition-colors"
        >
          Stop
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  import {
    initializeSessionManager,
    startStudySession,
    endStudySession,
    isSessionActive,
    onPresenceUpdate,
    onConnectionChange,
    getCurrentLocation,
    fetchActiveSessions,
    type StudyPresence,
    type ConnectionStatus,
  } from '../utils/study-session-manager';
  import { isSupabaseConfigured } from '../utils/supabase-client';
  import { getAvatarUrl } from '../utils/notion-faces';

  // Get all widgets on the page
  const widgets = document.querySelectorAll('.study-session-widget');

  widgets.forEach((widget) => {
    const container = widget as HTMLElement;
    const examSlug = container.dataset.examSlug || null;
    const examName = container.dataset.examName || null;

    // Elements
    const notStudying = container.querySelector('#widget-not-studying') as HTMLElement;
    const studying = container.querySelector('#widget-studying') as HTMLElement;
    const joinBtn = container.querySelector('#widget-join-btn') as HTMLButtonElement;
    const stopBtn = container.querySelector('#widget-stop-btn') as HTMLButtonElement;
    const activeCount = container.querySelector('#widget-active-count') as HTMLElement;
    const avatar = container.querySelector('#widget-avatar') as HTMLElement;
    const location = container.querySelector('#widget-location') as HTMLElement;
    const duration = container.querySelector('#widget-duration') as HTMLElement;

    /**
     * Format duration since a timestamp
     */
    function formatDuration(startedAt: string): string {
      const start = new Date(startedAt).getTime();
      const now = Date.now();
      const minutes = Math.floor((now - start) / 60000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m`;
      
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h`;
      
      return `${Math.floor(hours / 24)}d`;
    }

    /**
     * Update UI based on session state
     */
    function updateUI(): void {
      const active = isSessionActive();
      const loc = getCurrentLocation();
      
      if (active && loc) {
        notStudying?.classList.add('hidden');
        studying?.classList.remove('hidden');
        
        // Get avatar seed
        const seed = localStorage.getItem('timekeeper-avatar-seed') || 'user';
        
        // Show avatar as image instead of emoji
        if (avatar) {
          avatar.innerHTML = `<img src="${getAvatarUrl(seed)}" alt="" class="w-6 h-6 rounded-full" />`;
        }
        
        if (location) {
          const locText = [loc.city, loc.state].filter(Boolean).join(', ') || 'India';
          location.textContent = locText;
        }
        
        if (duration) duration.textContent = 'just now';
      } else {
        notStudying?.classList.remove('hidden');
        studying?.classList.add('hidden');
      }
    }

    /**
     * Update active user count
     */
    function updateCount(presences: StudyPresence[]): void {
      // Filter by exam if specified
      let count = presences.length;
      if (examSlug) {
        count = presences.filter(p => 
          p.examSlug?.toLowerCase().includes(examSlug.toLowerCase())
        ).length;
      }
      
      if (activeCount) {
        activeCount.textContent = count.toString();
      }
    }

    /**
     * Join study session
     */
    async function joinSession(): Promise<void> {
      if (joinBtn) joinBtn.disabled = true;
      
      try {
        const success = await startStudySession(examSlug, examName);
        if (success) {
          updateUI();
        }
      } catch (err) {
        console.error('[StudyWidget] Join failed:', err);
      }
      
      if (joinBtn) joinBtn.disabled = false;
    }

    /**
     * Leave study session
     */
    async function leaveSession(): Promise<void> {
      try {
        await endStudySession();
        updateUI();
      } catch (err) {
        console.error('[StudyWidget] Leave failed:', err);
      }
    }

    // Event listeners
    joinBtn?.addEventListener('click', joinSession);
    stopBtn?.addEventListener('click', leaveSession);

    // Subscribe to presence updates
    onPresenceUpdate(updateCount);

    // Check if Supabase is configured
    if (isSupabaseConfigured()) {
      // Initialize and load data
      initializeSessionManager().then(() => {
        if (isSessionActive()) {
          updateUI();
        }
      });
    } else {
      // Show 0 count if not configured
      if (activeCount) activeCount.textContent = '0';
    }
  });
</script>
