---
interface Props {
  exam?: any;
  currentUrl?: string;
}

const { exam, currentUrl = Astro.url.href } = Astro.props;
const baseUrl = 'https://timekeeper.edbn.me';

// Helper to calculate time left
function calculateTimeLeft(targetDate: string) {
  if (!targetDate) {
    return { expired: true, days: 0, hours: 0, minutes: 0, seconds: 0 };
  }
  const now = new Date().getTime();
  const target = new Date(targetDate).getTime();
  const distance = target - now;
  
  if (distance < 0) {
    return { expired: true, days: 0, hours: 0, minutes: 0, seconds: 0 };
  }
  
  const days = Math.floor(distance / (1000 * 60 * 60 * 24));
  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((distance % (1000 * 60)) / 1000);
  
  return { expired: false, days, hours, minutes, seconds };
}

// Generate dynamic title
function generateDynamicTitle(exam?: any): string {
  if (exam) {
    const timeLeft = calculateTimeLeft(exam.sessions?.[0]?.date || exam.date);
    if (timeLeft.expired) {
      return `${exam.name} 2026 Exam Date & Results - TimeKeeper`;
    }
    
    const timeString = timeLeft.days > 0 ? 
      `${timeLeft.days} Days ${timeLeft.hours}h` :
      `${timeLeft.hours}h ${timeLeft.minutes}m`;
    
    return `[${timeString} Left] ${exam.name} Countdown Timer 2026 | Live Exam Date Tracker`;
  }
  
  return 'TimeKeeper - Live Countdown Timer for Indian Exams 2026 | JEE, NEET, CAT';
}

// Generate dynamic meta description
function generateDynamicDescription(exam?: any): string {
  if (exam) {
    const timeLeft = calculateTimeLeft(exam.sessions?.[0]?.date || exam.date);
    const timeString = timeLeft.expired ? 'The exam date has passed. Check for result updates.' : 
      `Only ${timeLeft.days} days, ${timeLeft.hours} hours left!`;
    
    return `‚è∞ ${timeString} Track the ${exam.name} 2026 countdown LIVE. Our real-time timer shows you the exact time until the ${exam.fullName}. Features Picture-in-Picture mode, multiple session tracking, and shareable links. Free, no sign-up required.`;
  }
  
  return 'üèÜ Ultimate real-time countdown timer for all major Indian competitive exams 2026. Track JEE Mains, JEE Advanced, NEET, CAT, UPSC, and 50+ other exams. Features live countdowns, PiP mode, and shareable links. Free forever!';
}

// Generate dynamic SEO keywords
function generateDynamicKeywords(exam?: any): string[] {
  const baseKeywords = [
    'countdown timer', 'exam countdown', 'time keeper', 'timer app', 'exam timer', 'countdown clock', 'time tracker', 'exam date countdown', 'real time countdown', 'online timer', 'exam countdown app', 'competitive exam timer', 'entrance exam countdown', 'exam preparation timer', 'study timer', 'countdown widget', 'exam schedule tracker', 'time remaining calculator', 'exam day countdown', 'digital countdown timer'
  ];

  const indianExamKeywords = [
    'indian exams 2026', 'indian competitive exams', 'indian entrance exams', 'india exam countdown', 'nta exams', 'indian exam dates', 'competitive exam india', 'entrance exam india', 'indian exam calendar', 'exam countdown india'
  ];

  const timeKeywords = [
    'days hours minutes seconds', 'time left until exam', 'exam time remaining', 'countdown to exam', 'exam date tracker', 'time until exam', 'exam countdown clock', 'exam timer widget', 'live exam countdown', 'real time exam timer'
  ];

  if (exam) {
    const examSpecificKeywords = [
      `${exam.name} countdown`,
      `${exam.name} timer`,
      `${exam.name} 2026`,
      `${exam.name} exam date`,
      `${exam.name} countdown timer`,
      `${exam.fullName} countdown`,
      `${exam.conductingBody} exam`,
      `time left for ${exam.name}`,
      `${exam.name} exam countdown`,
      `${exam.name} time tracker`,
      `how many days until ${exam.name}`,
      `${exam.name} preparation`,
      `${exam.category} exams`,
      ...(exam.keywords || [])
    ];

    return [...new Set([...baseKeywords, ...indianExamKeywords, ...timeKeywords, ...examSpecificKeywords])];
  }

  return [...new Set([...baseKeywords, ...indianExamKeywords, ...timeKeywords])];
}

const dynamicTitle = generateDynamicTitle(exam);
const dynamicDescription = generateDynamicDescription(exam);
const dynamicKeywords = generateDynamicKeywords(exam);
---

<!-- SEO Meta Tags -->
<title>{dynamicTitle}</title>
<meta name="description" content={dynamicDescription} />
<meta name="keywords" content={dynamicKeywords.join(', ')} />

<!-- Robots Meta -->
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />

<!-- Open Graph (for social sharing) -->
<meta property="og:title" content={dynamicTitle} />
<meta property="og:description" content={dynamicDescription} />
<meta property="og:type" content={exam ? 'article' : 'website'} />
<meta property="og:url" content={currentUrl} />
<meta property="og:site_name" content="TimeKeeper - Indian Exams Countdown" />
<meta property="og:locale" content="en_IN" />
<meta property="og:image" content={`${baseUrl}/favicon.svg`} />
<meta property="og:image:width" content="512" />
<meta property="og:image:height" content="512" />
<meta property="og:image:alt" content="TimeKeeper Countdown Timer Logo" />

{exam && (
  <>
    <meta property="article:author" content="TimeKeeper" />
    <meta property="article:published_time" content="2025-01-01T00:00:00Z" />
    <meta property="article:modified_time" content={new Date().toISOString()} />
    <meta property="article:section" content={exam.category} />
    {exam.keywords?.map((keyword: string) => <meta property="article:tag" content={keyword} />)}
  </>
)}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={dynamicTitle} />
<meta name="twitter:description" content={dynamicDescription} />
<meta name="twitter:image" content={`${baseUrl}/favicon.svg`} />
<meta name="twitter:image:alt" content="TimeKeeper Exam Countdown Timer Logo" />
<meta name="twitter:site" content="@timekeeper" />

<!-- Canonical URL -->
<link rel="canonical" href={currentUrl} />

<!-- Other Meta -->
<meta name="generator" content={Astro.generator} />
<meta name="theme-color" content="#ffffff" />